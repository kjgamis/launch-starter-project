/***************************************************************************************
 * (c) 2017 Adobe. All rights reserved.
 * This file is licensed to you under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License. You may obtain a copy
 * of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under
 * the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
 * OF ANY KIND, either express or implied. See the License for the specific language
 * governing permissions and limitations under the License.
 ****************************************************************************************/(function(){"use strict";function a(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function b(b){for(var c=1;c<arguments.length;c++){var d=null==arguments[c]?{}:arguments[c],e=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(d).filter(function(a){return Object.getOwnPropertyDescriptor(d,a).enumerable}))),e.forEach(function(c){a(b,c,d[c])})}return b}var c=function(a,b){return b={exports:{}},a(b,b.exports),b.exports}(function(a,b){Object.defineProperty(b,"__esModule",{value:!0});var c="handshake-reply",d="call",e="reply",f="fulfilled",g="rejected",h="message",i=b.ERR_CONNECTION_DESTROYED="ConnectionDestroyed",j=b.ERR_CONNECTION_TIMEOUT="ConnectionTimeout",k=b.ERR_NOT_IN_IFRAME="NotInIframe",l={"http:":"80","https:":"443"},m=/^(https?:)?\/\/([^\/:]+)(:(\d+))?/,n={ERR_CONNECTION_DESTROYED:i,ERR_CONNECTION_TIMEOUT:j,ERR_NOT_IN_IFRAME:k,Promise:function(){try{return window?window.Promise:null}catch(a){return null}}(),debug:!1},o=function(){var a=0;return function(){return++a}}(),p=function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];if(n.debug){var d;(d=console).log.apply(d,["[Penpal]"].concat(b))}},q=function(a){var b=document.location,c=m.exec(a),d=void 0,e=void 0,f=void 0;c?(d=c[1]?c[1]:b.protocol,e=c[2],f=c[4]):(d=b.protocol,e=b.hostname,f=b.port);var g=f&&f!==l[d]?":"+f:"";return d+"//"+e+g},r=function(a){var b=[];return a(function(){b.forEach(function(a){a()})}),{then:function(a){b.push(a)}}},s=function(a){var b=a.name,c=a.message,d=a.stack;return{name:b,message:c,stack:d}},t=function(a){var b=new Error;return Object.keys(a).forEach(function(c){return b[c]=a[c]}),b},u=function(a,b,c,g){var j=b.localName,k=b.local,l=b.remote,m=b.remoteOrigin,q=!1;p(j+": Connecting call sender");var r=function(a){return function(){for(var b=arguments.length,c=Array(b),g=0;g<b;g++)c[g]=arguments[g];if(p(j+": Sending "+a+"() call"),q){var r=new Error("Unable to send "+a+"() call due to destroyed connection");throw r.code=i,r}return new n.Promise(function(b,g){var i=o();k.addEventListener(h,function c(d){if(d.source===l&&d.origin===m&&d.data.penpal===e&&d.data.id===i){p(j+": Received "+a+"() reply"),k.removeEventListener(h,c);var n=d.data.returnValue;d.data.returnValueIsError&&(n=t(n)),(d.data.resolution===f?b:g)(n)}}),l.postMessage({penpal:d,id:i,methodName:a,args:c},m)})}};g.then(function(){q=!0}),c.reduce(function(a,b){return a[b]=r(b),a},a)},v=function(a,b,c){var i=a.localName,j=a.local,k=a.remote,l=a.remoteOrigin,m=!1;p(i+": Connecting call receiver");var o=function(a){if(a.source===k&&a.origin===l&&a.data.penpal===d){var c=a.data,h=c.methodName,j=c.args,o=c.id;if(p(i+": Received "+h+"() call"),h in b){var q=function(a){return function(b){if(p(i+": Sending "+h+"() reply"),m)return void p(i+": Unable to send "+h+"() reply due to destroyed connection");var c={penpal:e,id:o,resolution:a,returnValue:b};a===g&&b instanceof Error&&(c.returnValue=s(b),c.returnValueIsError=!0);try{k.postMessage(c,l)}catch(a){throw a.name==="DataCloneError"&&k.postMessage({penpal:e,id:o,resolution:g,returnValue:s(a),returnValueIsError:!0},l),a}}};new n.Promise(function(a){return a(b[h].apply(b,j))}).then(q(f),q(g))}}};j.addEventListener(h,o),c.then(function(){m=!0,j.removeEventListener(h,o)})};n.connectToChild=function(a){var b=a.url,d=a.appendTo,e=a.methods,f=e===void 0?{}:e,g=a.timeout,k=void 0,l=new r(function(a){k=a}),m=window,o=document.createElement("iframe");(d||document.body).appendChild(o),l.then(function(){o.parentNode&&o.parentNode.removeChild(o)});var s=o.contentWindow||o.contentDocument.parentWindow,t=q(b),w=new n.Promise(function(a,d){var e;g!==void 0&&(e=setTimeout(function(){var a=new Error("Connection to child timed out after "+g+"ms");a.code=j,d(a),k()},g));var n={},q=void 0,w=void 0,x=function(b){if(b.source===s&&b.origin===t&&b.data.penpal==="handshake"){p("Parent: Received handshake, sending reply"),b.source.postMessage({penpal:c,methodNames:Object.keys(f)},b.origin);var d={localName:"Parent",local:m,remote:s,remoteOrigin:b.origin};w&&w();var g=new r(function(a){l.then(a),w=a});v(d,f,g),q&&q.forEach(function(a){delete n[a]}),q=b.data.methodNames,u(n,d,q,l),clearTimeout(e),a(n)}};m.addEventListener(h,x),l.then(function(){m.removeEventListener(h,x);var a=new Error("Connection destroyed");a.code=i,d(a)}),p("Parent: Loading iframe"),o.src=b});return{promise:w,iframe:o,destroy:k}},n.connectToParent=function(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},b=a.parentOrigin,d=b===void 0?"*":b,e=a.methods,f=e===void 0?{}:e,g=a.timeout;if(window===window.top){var l=new Error("connectToParent() must be called within an iframe");throw l.code=k,l}var m=void 0,o=new r(function(a){m=a}),q=window,s=q.parent,t=new n.Promise(function(a,b){var e;g!==void 0&&(e=setTimeout(function(){var a=new Error("Connection to parent timed out after "+g+"ms");a.code=j,b(a),m()},g));var k=function b(g){if(("*"===d||d===g.origin)&&g.source===s&&g.data.penpal===c){p("Child: Received handshake reply"),q.removeEventListener(h,b);var i={localName:"Child",local:q,remote:s,remoteOrigin:g.origin},j={};v(i,f,o),u(j,i,g.data.methodNames,o),clearTimeout(e),a(j)}};q.addEventListener(h,k),o.then(function(){q.removeEventListener(h,k);var a=new Error("Connection destroyed");a.code=i,b(a)}),p("Child: Sending handshake"),s.postMessage({penpal:"handshake",methodNames:Object.keys(f)},d)});return{promise:t,destroy:m}},b.default=n}),d=function(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}(c),e=c.ERR_CONNECTION_DESTROYED,f=c.ERR_CONNECTION_TIMEOUT,g=c.ERR_NOT_IN_IFRAME;const h=function(a){this.moduleName=a};["log","info","warn","error"].forEach(a=>{h.prototype[a]=function(){if(h.enabled){for(var b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];console[a](`[${this.moduleName}]`,...c)}}}),h.enabled=!1;(a=>{const b=document.createElement("style");b.appendChild(document.createTextNode(a)),document.head.appendChild(b)})("\n  html, body {\n    background-color: transparent !important;\n  }\n");const i=new h("ExtensionBridge:Child");let j,k={};const l=a=>{const b=k[a];if(b)return b.bind(k);throw new Error(`Unable to call ${a} on the extension. The extension must register a ${a} function using extensionBridge.register().`)},m=(a,b)=>function(){for(var c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];let f;return"function"==typeof d[0]&&(f=d.shift(),console.warn("Passing a callback to extensionBridge."+a+"() has been deprecated. The method now returns a promise that should be used instead.")),j.then(c=>{if(c[a])return c[a](...d);throw new Error(`An error occurred while opening ${b}. The shared view is unavailable.`)}).then(a=>(f&&f(a),a))};j=d.connectToParent({methods:{init:function(){l("init")(...arguments)},validate:function(){const a=l("validate")(...arguments);if("boolean"!=typeof a)throw new Error(`The extension attempted to return a non-boolean value from validate: ${a}`);return a},getSettings:function(){const a=l("getSettings")(...arguments);if("object"!=typeof a)throw new Error("The extension attempted to return a non-object value from getSettings: "+a);return a}}}).promise;const n={openCodeEditor:m("openCodeEditor","code editor"),openDataElementSelector:m("openDataElementSelector","data element selector"),openRegexTester:m("openRegexTester","regex tester"),register(a){k=b({},a),j.then(a=>a.extensionRegistered()),i.log("Methods registered by extension.")},setDebug(a){d.debug=a,h.enabled=a}};window.addEventListener("focus",()=>{j.then(a=>a.markAsDirty())});const o=a=>{Promise.resolve(n[a.methodName](...a.args)).then(a.resolve,a.reject)},p=window.extensionBridge._callQueue;for(;p.length;)o(p.shift());p.push=o})();
